generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  COACH
  ADMIN
  ATHLETE
}

enum CalendarItemStatus {
  PLANNED
  COMPLETED_MANUAL
  COMPLETED_SYNCED
  COMPLETED_SYNCED_DRAFT
  SKIPPED
  MODIFIED
}

enum CompletionSource {
  MANUAL
  STRAVA
  GARMIN
  FILE
}

enum GroupVisibilityType {
  ALL
  SQUAD
  SELECTED
}

enum PlanWeekStatus {
  DRAFT
  PUBLISHED
}

enum OAuthProvider {
  STRAVA
  GARMIN
  WAHOO
  COROS
}

enum ExternalProvider {
  STRAVA
  GARMIN
  WAHOO
  COROS
  POLAR
}

enum ExternalWebhookEventStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum TrainingPlanFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  AD_HOC
}

enum WorkoutLibraryDiscipline {
  RUN
  BIKE
  SWIM
  BRICK
  STRENGTH
  OTHER
}

enum WorkoutLibraryIntensityCategory {
  Z1
  Z2
  Z3
  Z4
  Z5
  RPE
  OTHER
}

enum WorkoutLibrarySessionStatus {
  DRAFT
  PUBLISHED
}

enum WorkoutLibrarySource {
  MANUAL
  PLAN_LIBRARY
}

enum AthletePlanStatus {
  ACTIVE
  ARCHIVED
}

enum StravaSyncIntentStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

// --- AI Plan Builder (v1) ---
// Tranche 1: additive models only. No coupling to existing plan workflows.

enum AthleteIntakeResponseStatus {
  DRAFT
  SUBMITTED
}

enum AthleteProfileAIStatus {
  DRAFT
  APPROVED
}

enum AiPlanDraftSource {
  AI_DRAFT
}

enum AiPlanDraftStatus {
  DRAFT
}

enum AiPlanDraftVisibilityStatus {
  DRAFT
  PUBLISHED
}

// --- PlanSource (v1) ---
enum PlanSourceType {
  PDF
  URL
  TEXT
}

enum PlanSport {
  TRIATHLON
  DUATHLON
  RUN
  BIKE
  SWIM
}

enum PlanDistance {
  SPRINT
  OLYMPIC
  HALF_IRONMAN
  IRONMAN
  DUATHLON_STD
  DUATHLON_SPRINT
  FIVE_K
  TEN_K
  HALF_MARATHON
  MARATHON
  OTHER
}

enum PlanLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PlanSeason {
  IN_SEASON
  BASE
  WINTER
  BUILD
  PEAK
  TAPER
}

enum PlanPhase {
  BASE
  BUILD
  PEAK
  TAPER
  RACE
  RECOVERY
}

enum RuleType {
  DISCIPLINE_SPLIT
  WEEKLY_VOLUME
  LONG_SESSION
  INTENSITY_DENSITY
  BRICKS
  DELoad
  FREQUENCY
  REST_DAYS
  PROGRESSION_CAP
  EQUIPMENT_ASSUMPTIONS
  RISK_GUARDS
  NOTES_STYLE
}

enum PlanSourceDiscipline {
  SWIM
  BIKE
  RUN
  STRENGTH
  REST
}

enum PlanChangeProposalStatus {
  DRAFT
  PROPOSED
  APPROVED
  REJECTED
  APPLIED
  EXPIRED
}

enum AthleteSessionFeedbackCompletedStatus {
  DONE
  PARTIAL
  SKIPPED
}

enum AthleteSessionFeedbackFeel {
  EASY
  OK
  HARD
  TOO_HARD
}

enum AdaptationTriggerType {
  MISSED_KEY
  SORENESS
  TOO_HARD
  HIGH_COMPLIANCE
}

enum PlanChangeAuditActorType {
  COACH
  AI_SYSTEM
}

enum AiInvocationActorType {
  COACH
  ATHLETE
  SYSTEM
}

// --- AI Plan Builder (Tranche 12) ---
// Usage rollups + directional cost estimates + soft alerts.

enum AiUsageAlertSeverity {
  INFO
  WARN
  ERROR
}

enum AiUsageAlertType {
  HIGH_CALL_VOLUME
  HIGH_FALLBACK_RATE
  HIGH_ERROR_RATE
  HIGH_RETRY_RATE
  HIGH_P95_LATENCY
  HIGH_COST_ESTIMATE
}

enum AiUsageAlertScope {
  GLOBAL
  CAPABILITY
  COACH
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  role           UserRole
  timezone       String   @default("Australia/Brisbane")
  authProviderId String?  @unique // Clerk user ID for authentication
  createdAt      DateTime @default(now())

  // Relations
  athleteProfile                  AthleteProfile?
  coachedAthletes                 AthleteProfile[]         @relation("CoachToAthletes")
  comments                        Comment[]
  messageThreadsAsCoach           MessageThread[]          @relation("CoachThreads")
  messageThreadsAsAthlete         MessageThread[]          @relation("AthleteThreads")
  messages                        Message[]
  squads                          Squad[]
  squadTemplates                  SquadTemplate[]
  workoutTemplates                WorkoutTemplate[]
  groupSessions                   GroupSession[]
  calendarItemsCoached            CalendarItem[]
  branding                        CoachBranding?
  workoutTitles                   WorkoutTitle[]
  planWeeks                       PlanWeek[]
  coachJournalEntries             CoachJournalEntry[]
  oauthStates                     OAuthState[]
  workoutLibrarySessionsCreated   WorkoutLibrarySession[]
  workoutLibrarySessionsPublished WorkoutLibrarySession[]  @relation("WorkoutLibrarySessionPublishedBy")
  workoutLibraryFavorites         WorkoutLibraryFavorite[]
  workoutLibraryUsage             WorkoutLibraryUsage[]

  athletePlanInstances      AthletePlanInstance[] @relation("AthletePlanInstances")
  coachCreatedPlanInstances AthletePlanInstance[] @relation("CoachCreatedPlanInstances")

  // AI Plan Builder (v1)
  aiPlanBuilderIntakeResponses    AthleteIntakeResponse[]
  aiPlanBuilderEvidence           IntakeEvidence[]
  aiPlanBuilderProfiles           AthleteProfileAI[]
  aiPlanBuilderIntents            CoachIntent[]
  aiPlanBuilderDraftPlans         AiPlanDraft[]
  aiPlanBuilderProposals          PlanChangeProposal[]
  aiPlanBuilderAudits             PlanChangeAudit[]
  aiPlanBuilderSessionFeedback    AthleteSessionFeedback[]
  aiPlanBuilderAdaptationTriggers AdaptationTrigger[]

  athleteIntakeSubmissions AthleteIntakeSubmission[] @relation("CoachToIntakeSubmissions")
  athleteBriefs            AthleteBrief[]            @relation("CoachToAthleteBriefs")

  // AI Plan Builder (Tranche 10)
  aiInvocationAudits       AiInvocationAudit[]      @relation("AiInvocationAuditCoach")
  aiLlmRateLimitEvents     AiLlmRateLimitEvent[]    @relation("AiLlmRateLimitEventCoach")

  @@index([role])
}

model WorkoutLibrarySession {
  id                  String                           @id @default(cuid())
  title               String
  discipline          WorkoutLibraryDiscipline
  status              WorkoutLibrarySessionStatus      @default(DRAFT)
  source              WorkoutLibrarySource             @default(MANUAL)
  externalSessionId   String?                          @unique
  fingerprint         String?                          @unique
  tags                String[]
  description         String
  durationSec         Int
  intensityTarget     String
  intensityCategory   WorkoutLibraryIntensityCategory?
  distanceMeters      Float?
  elevationGainMeters Float?
  notes               String?
  category            String?
  rawText             String?
  paceTargetsJson     Json?
  prescriptionJson    Json?
  equipment           String[]
  workoutStructure    Json?
  publishedAt         DateTime?
  publishedByUserId   String?
  createdAt           DateTime                         @default(now())
  updatedAt           DateTime                         @updatedAt
  createdByUserId     String?

  createdByUser            User?                     @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  publishedByUser          User?                     @relation("WorkoutLibrarySessionPublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  favorites                WorkoutLibraryFavorite[]
  usage                    WorkoutLibraryUsage[]
  planTemplateScheduleRows PlanTemplateScheduleRow[]

  @@index([discipline])
  @@index([status])
  @@index([source])
  @@index([publishedAt])
  @@index([title])
  @@index([intensityCategory])
  @@index([tags], type: Gin)
}

model WorkoutLibraryFavorite {
  id               String   @id @default(cuid())
  coachId          String
  librarySessionId String
  createdAt        DateTime @default(now())

  coach          User                  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  librarySession WorkoutLibrarySession @relation(fields: [librarySessionId], references: [id], onDelete: Cascade)

  @@unique([coachId, librarySessionId])
  @@index([coachId])
  @@index([librarySessionId])
}

model WorkoutLibraryUsage {
  id               String   @id @default(cuid())
  coachId          String
  librarySessionId String
  usedAt           DateTime @default(now())

  coach          User                  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  librarySession WorkoutLibrarySession @relation(fields: [librarySessionId], references: [id], onDelete: Cascade)

  @@index([librarySessionId, usedAt])
  @@index([coachId, usedAt])
}

model AthleteProfile {
  userId                  String                @id
  coachId                 String
  // Identity (canonical)
  firstName        String?
  lastName         String?
  dateOfBirth      DateTime?
  gender           String?
  timezone         String?
  trainingSuburb   String?
  email            String?
  mobilePhone      String?

  // Sport context
  disciplines      String[] // e.g. ["RUN","BIKE","SWIM"]
  primaryGoal      String?
  secondaryGoals   String[] @default([])
  focus            String?
  eventName        String?
  eventDate        DateTime?
  timelineWeeks    Int?

  // Training profile
  experienceLevel     String?
  weeklyMinutesTarget Int?
  consistencyLevel    String?
  swimConfidence      Int?
  bikeConfidence      Int?
  runConfidence       Int?

  // Constraints
  availableDays       String[] @default([])
  scheduleVariability String?
  sleepQuality        String?
  equipmentAccess     String?
  travelConstraints   String?
  injuryStatus        String?
  constraintsNotes    String?

  // Coaching preferences
  feedbackStyle       String?
  tonePreference      String?
  checkInCadence      String?
  structurePreference Int?
  motivationStyle     String?

  // Coach-owned fields (never overwritten by intake)
  trainingPlanSchedule Json?
  coachNotes           String?
  painHistory          Json?
  coachJournal         String?

  // Legacy fields (deprecated)
  goalsText               String?
  planCadenceDays         Int                   @default(7) // LEGACY: kept for backward compatibility. Do not use in UI. Use trainingPlanSchedule.
  trainingPlanFrequency   TrainingPlanFrequency @default(AD_HOC)
  trainingPlanDayOfWeek   Int?
  trainingPlanWeekOfMonth Int?
  zonesJson               Json?

  // Calendar Sync (private iCal subscription)
  icalToken          String?   @unique
  icalTokenRotatedAt DateTime?

  // v1: Default location for weather on workout detail pages.
  defaultLat           Float?
  defaultLon           Float?
  defaultLocationLabel String?

  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  coach User @relation("CoachToAthletes", fields: [coachId], references: [id], onDelete: Restrict)

  calendarItems       CalendarItem[]
  completedActivities CompletedActivity[]
  painReports         PainReport[]
  squadMemberships    SquadMember[]
  groupSessionTargets GroupSessionTarget[]
  planWeeks           PlanWeek[]
  coachJournalEntries CoachJournalEntry[]
  stravaConnection    StravaConnection?
  stravaSyncIntents   StravaSyncIntent[]
  externalConnections ExternalConnection[]
  externalWebhookEvents ExternalWebhookEvent[]

  // AI Plan Builder (v1)
  aiPlanBuilderIntakeResponses    AthleteIntakeResponse[]
  aiPlanBuilderEvidence           IntakeEvidence[]
  aiPlanBuilderProfiles           AthleteProfileAI[]
  aiPlanBuilderIntents            CoachIntent[]
  aiPlanBuilderDraftPlans         AiPlanDraft[]
  aiPlanBuilderProposals          PlanChangeProposal[]
  aiPlanBuilderAudits             PlanChangeAudit[]
  aiPlanBuilderSessionFeedback    AthleteSessionFeedback[]
  aiPlanBuilderAdaptationTriggers AdaptationTrigger[]
  aiPlanBuilderPublishAcks        AiPlanPublishAck[]

  intakeSubmissions AthleteIntakeSubmission[]
  athleteBriefs     AthleteBrief[]

  // AI Plan Builder (Tranche 10)
  aiInvocationAudits   AiInvocationAudit[]   @relation("AiInvocationAuditAthlete")
  aiLlmRateLimitEvents AiLlmRateLimitEvent[] @relation("AiLlmRateLimitEventAthlete")

  @@index([coachId])
}

model Squad {
  id        String   @id @default(cuid())
  coachId   String
  name      String
  createdAt DateTime @default(now())

  coach               User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  members             SquadMember[]
  groupSessionTargets GroupSessionTarget[]
  squadTemplateTargets SquadTemplateTarget[]

  @@unique([coachId, name])
  @@index([coachId])
}

model SquadTemplate {
  id             String   @id @default(cuid())
  coachId        String
  name           String
  description    String?
  targetPresetJson Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  coach   User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  targets SquadTemplateTarget[]

  @@unique([coachId, name])
  @@index([coachId, createdAt])
}

model SquadTemplateTarget {
  id              String   @id @default(cuid())
  squadTemplateId String
  squadId         String
  createdAt       DateTime @default(now())

  squadTemplate SquadTemplate @relation(fields: [squadTemplateId], references: [id], onDelete: Cascade)
  squad         Squad         @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@unique([squadTemplateId, squadId])
  @@index([squadTemplateId])
  @@index([squadId])
}

model SquadMember {
  squadId   String
  athleteId String // references AthleteProfile.userId
  createdAt DateTime @default(now())

  squad   Squad          @relation(fields: [squadId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@id([squadId, athleteId])
  @@index([athleteId])
}

model WorkoutTemplate {
  id                 String   @id @default(cuid())
  coachId            String
  discipline         String
  subtype            String?
  title              String
  structureJson      Json?
  defaultTargetsJson Json?
  notes              String?
  attachmentsJson    Json?
  createdAt          DateTime @default(now())

  coach         User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  calendarItems CalendarItem[]

  @@index([coachId])
  @@index([discipline])
}

model WorkoutTitle {
  id         String   @id @default(cuid())
  coachId    String
  discipline String
  title      String
  isArchived Boolean  @default(false)
  createdAt  DateTime @default(now())

  coach User @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, discipline, title])
  @@index([coachId, discipline, isArchived])
}

model PlanTemplate {
  id                String   @id @default(cuid())
  externalPlanId    String   @unique
  name              String
  tags              String[] @default([])
  level             String?
  durationDays      Int?
  goalDistancesJson Json?
  goalTimesJson     Json?
  sourceFile        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  scheduleRows         PlanTemplateScheduleRow[]
  athletePlanInstances AthletePlanInstance[]

  @@index([externalPlanId])
}

model PlanTemplateScheduleRow {
  id                      String   @id @default(cuid())
  planTemplateId          String
  workoutLibrarySessionId String?
  weekIndex               Int
  dayIndex                Int
  dayOfWeek               Int
  isOptional              Boolean  @default(false)
  isOff                   Boolean  @default(false)
  rawText                 String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  planTemplate             PlanTemplate              @relation(fields: [planTemplateId], references: [id], onDelete: Cascade)
  workoutLibrarySession    WorkoutLibrarySession?    @relation(fields: [workoutLibrarySessionId], references: [id], onDelete: SetNull)
  athletePlanInstanceItems AthletePlanInstanceItem[]

  @@unique([planTemplateId, dayIndex])
  @@index([planTemplateId, weekIndex])
  @@index([planTemplateId, dayOfWeek])
}

model AthletePlanInstance {
  id               String            @id @default(cuid())
  athleteId        String
  planTemplateId   String
  startDateLocal   DateTime
  timezone         String
  status           AthletePlanStatus @default(ACTIVE)
  createdByCoachId String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  athlete        User                      @relation("AthletePlanInstances", fields: [athleteId], references: [id], onDelete: Cascade)
  planTemplate   PlanTemplate              @relation(fields: [planTemplateId], references: [id], onDelete: Restrict)
  createdByCoach User                      @relation("CoachCreatedPlanInstances", fields: [createdByCoachId], references: [id], onDelete: Restrict)
  items          AthletePlanInstanceItem[]
  calendarItems  CalendarItem[]

  @@index([athleteId, status])
  @@index([planTemplateId])
  @@index([createdByCoachId])
}

model AthletePlanInstanceItem {
  id                        String   @id @default(cuid())
  athletePlanInstanceId     String
  planTemplateScheduleRowId String
  calendarItemId            String
  createdAt                 DateTime @default(now())

  athletePlanInstance     AthletePlanInstance     @relation(fields: [athletePlanInstanceId], references: [id], onDelete: Cascade)
  planTemplateScheduleRow PlanTemplateScheduleRow @relation(fields: [planTemplateScheduleRowId], references: [id], onDelete: Cascade)
  calendarItem            CalendarItem            @relation(fields: [calendarItemId], references: [id], onDelete: Cascade)

  @@unique([athletePlanInstanceId, planTemplateScheduleRowId])
  @@index([calendarItemId])
}

model PlanSource {
  id             String         @id @default(cuid())
  type           PlanSourceType
  title          String
  sport          PlanSport
  distance       PlanDistance
  level          PlanLevel
  durationWeeks  Int
  season         PlanSeason?
  author         String?
  publisher      String?
  licenseText    String?
  sourceUrl      String?
  sourceFilePath String?
  checksumSha256 String         @unique
  isActive       Boolean        @default(false)
  rawText        String
  rawJson        Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  versions PlanSourceVersion[]
}

model PlanSourceVersion {
  id                 String   @id @default(cuid())
  planSourceId       String
  version            Int
  extractionMetaJson Json
  createdAt          DateTime @default(now())

  planSource PlanSource             @relation(fields: [planSourceId], references: [id], onDelete: Cascade)
  weeks      PlanSourceWeekTemplate[]
  rules      PlanSourceRule[]

  @@unique([planSourceId, version])
  @@index([planSourceId, version])
}

model PlanSourceWeekTemplate {
  id                  String   @id @default(cuid())
  planSourceVersionId String
  weekIndex           Int
  phase               PlanPhase?
  totalMinutes        Int?
  totalSessions       Int?
  notes               String?

  planSourceVersion PlanSourceVersion          @relation(fields: [planSourceVersionId], references: [id], onDelete: Cascade)
  sessions          PlanSourceSessionTemplate[]

  @@unique([planSourceVersionId, weekIndex])
  @@index([planSourceVersionId, weekIndex])
}

model PlanSourceSessionTemplate {
  id                      String   @id @default(cuid())
  planSourceWeekTemplateId String
  ordinal                 Int
  dayOfWeek               Int?
  discipline              PlanSourceDiscipline
  sessionType             String
  title                   String?
  durationMinutes         Int?
  distanceKm              Float?
  intensityType           String?
  intensityTargetJson     Json?
  structureJson           Json?
  notes                   String?

  planSourceWeekTemplate PlanSourceWeekTemplate @relation(fields: [planSourceWeekTemplateId], references: [id], onDelete: Cascade)

  @@unique([planSourceWeekTemplateId, ordinal])
  @@index([planSourceWeekTemplateId, dayOfWeek])
}

model PlanSourceRule {
  id                  String    @id @default(cuid())
  planSourceVersionId String
  ruleType            RuleType
  phase               PlanPhase?
  appliesJson         Json
  ruleJson            Json
  explanation         String
  priority            Int       @default(1)
  createdAt           DateTime  @default(now())

  planSourceVersion PlanSourceVersion @relation(fields: [planSourceVersionId], references: [id], onDelete: Cascade)

  @@index([planSourceVersionId, ruleType])
  @@index([planSourceVersionId, phase])
}

model GroupSession {
  id               String              @id @default(cuid())
  coachId          String
  title            String
  discipline       String
  location         String?
  locationLat      Float?
  locationLon      Float?
  startTimeLocal   String // "06:00" etc (keep MVP simple)
  durationMinutes  Int
  distanceMeters   Float?
  intensityTarget  String?
  tags             String[]            @default([])
  equipment        String[]            @default([])
  workoutStructure Json?
  notes            String?
  description      String?
  recurrenceRule   String // iCal RRULE string
  visibilityType   GroupVisibilityType @default(ALL)
  createdAt        DateTime            @default(now())

  coach         User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  targets       GroupSessionTarget[]
  calendarItems CalendarItem[]

  @@index([coachId])
}

model GroupSessionTarget {
  id             String  @id @default(cuid())
  groupSessionId String
  athleteId      String?
  squadId        String?

  groupSession GroupSession    @relation(fields: [groupSessionId], references: [id], onDelete: Cascade)
  athlete      AthleteProfile? @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  squad        Squad?          @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@index([groupSessionId])
  @@index([athleteId])
  @@index([squadId])
}

model CalendarItem {
  id                     String             @id @default(cuid())
  athleteId              String // AthleteProfile.userId
  coachId                String
  athletePlanInstanceId  String?
  date                   DateTime // use date-only at midnight; interpret in timezone in UI
  plannedStartTimeLocal  String?
  coachEdited            Boolean            @default(false)
  // For non-planned sessions (e.g. recorded-from-provider).
  origin                 String?
  planningStatus         String?
  sourceActivityId       String?
  discipline             String
  subtype                String?
  title                  String
  plannedDurationMinutes Int?
  plannedDistanceKm      Float?
  distanceMeters         Float?
  intensityTarget        String?
  tags                   String[]           @default([])
  equipment              String[]           @default([])
  workoutStructure       Json?
  notes                  String?
  intensityType          String?
  intensityTargetJson    Json?
  workoutDetail          String?
  attachmentsJson        Json?
  status                 CalendarItemStatus @default(PLANNED)
  templateId             String?
  groupSessionId         String?
  reviewedAt             DateTime?
  actionAt               DateTime?

  deletedAt       DateTime?
  deletedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete             AthleteProfile       @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  coach               User                 @relation(fields: [coachId], references: [id], onDelete: Restrict)
  athletePlanInstance AthletePlanInstance? @relation(fields: [athletePlanInstanceId], references: [id], onDelete: SetNull)
  template            WorkoutTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  groupSession        GroupSession?        @relation(fields: [groupSessionId], references: [id], onDelete: SetNull)

  completedActivities      CompletedActivity[]
  comments                 Comment[]
  athletePlanInstanceItems AthletePlanInstanceItem[]

  @@unique([athleteId, origin, sourceActivityId])
  @@index([athleteId, date])
  @@index([coachId, date])
  @@index([coachId, athleteId, date])
  @@index([reviewedAt])
  @@index([coachId, reviewedAt, actionAt])
  @@index([status])
  @@index([coachId, reviewedAt, status])
  @@index([deletedAt])
  @@index([athletePlanInstanceId])
}

model CompletedActivity {
  id                 String           @id @default(cuid())
  athleteId          String
  calendarItemId     String?
  source             CompletionSource
  externalProvider   String?
  externalActivityId String?
  startTime          DateTime
  durationMinutes    Int
  distanceKm         Float?
  rpe                Int?
  notes              String?
  painFlag           Boolean          @default(false)
  confirmedAt        DateTime?
  metricsJson        Json?
  matchConfidence    String?
  matchScore         Int?
  matchDayDiff       Int?
  matchTimeDiffMinutes Int?
  fileUrl            String?
  createdAt          DateTime         @default(now())

  athlete      AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  calendarItem CalendarItem?  @relation(fields: [calendarItemId], references: [id], onDelete: SetNull)

  @@unique([athleteId, source, externalActivityId])
  @@index([athleteId, startTime])
  @@index([calendarItemId])
}

model Comment {
  id             String   @id @default(cuid())
  calendarItemId String
  authorId       String
  body           String
  createdAt      DateTime @default(now())

  calendarItem CalendarItem @relation(fields: [calendarItemId], references: [id], onDelete: Cascade)
  author       User         @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([calendarItemId, createdAt])
}

model MessageThread {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach    User      @relation("CoachThreads", fields: [coachId], references: [id], onDelete: Cascade)
  athlete  User      @relation("AthleteThreads", fields: [athleteId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([coachId, athleteId])
  @@index([coachId])
  @@index([athleteId])
}

model Message {
  id           String   @id @default(cuid())
  threadId     String
  senderUserId String   @map("authorId")
  senderRole   UserRole @default(COACH)
  body         String
  createdAt    DateTime @default(now())

  deletedAt       DateTime?
  deletedByUserId String?

  coachReadAt     DateTime?
  athleteReadAt   DateTime?
  coachReviewedAt DateTime?

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User          @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model PainReport {
  id           String   @id @default(cuid())
  athleteId    String
  date         DateTime
  bodyLocation String
  severity     Int
  durationDays Int?
  notes        String?
  createdAt    DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId, date])
}

model PlanWeek {
  id          String         @id @default(cuid())
  coachId     String
  athleteId   String // AthleteProfile.userId
  weekStart   DateTime // Monday date at midnight
  status      PlanWeekStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  coach   User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@unique([coachId, athleteId, weekStart])
  @@index([coachId, weekStart])
  @@index([athleteId, weekStart])
}

model CoachBranding {
  coachId     String   @id
  displayName String   @default("CoachKit")
  logoUrl     String?
  darkLogoUrl String?
  updatedAt   DateTime @updatedAt

  coach User @relation(fields: [coachId], references: [id], onDelete: Cascade)
}

model CoachJournalEntry {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String // AthleteProfile.userId
  entryDate DateTime
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach   User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId, entryDate(sort: Desc)])
  @@index([coachId])
}

model OAuthState {
  id         String        @id @default(cuid())
  provider   OAuthProvider
  userId     String
  state      String        @unique
  redirectTo String?
  expiresAt  DateTime
  createdAt  DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([provider, userId])
  @@index([expiresAt])
}

model StravaConnection {
  id              String    @id @default(cuid())
  athleteId       String    @unique // AthleteProfile.userId
  stravaAthleteId String    @unique
  accessToken     String
  refreshToken    String
  expiresAt       DateTime
  scope           String?
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId])
  @@index([stravaAthleteId])
  @@index([expiresAt])
}

model StravaSyncIntent {
  id               String @id @default(cuid())
  athleteId        String // AthleteProfile.userId
  stravaAthleteId  String
  stravaActivityId String
  eventType        String

  status        StravaSyncIntentStatus @default(PENDING)
  attempts      Int                    @default(0)
  nextAttemptAt DateTime?
  lastError     String?

  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@unique([athleteId, stravaActivityId])
  @@index([status, createdAt])
  @@index([athleteId, status])
}

model ExternalConnection {
  id               String           @id @default(cuid())
  athleteId        String
  provider         ExternalProvider
  externalAthleteId String
  accessToken      String
  refreshToken     String?
  expiresAt        DateTime?
  scope            String?
  lastSyncAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@unique([athleteId, provider])
  @@unique([provider, externalAthleteId])
  @@index([provider, lastSyncAt])
}

model ExternalWebhookEvent {
  id                 String                    @id @default(cuid())
  provider           ExternalProvider
  athleteId          String?
  externalAthleteId  String?
  externalActivityId String?
  eventType          String?
  status             ExternalWebhookEventStatus @default(PENDING)
  attempts           Int                        @default(0)
  nextAttemptAt      DateTime?
  processedAt        DateTime?
  lastError          String?
  payloadJson        Json
  receivedAt         DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  athlete AthleteProfile? @relation(fields: [athleteId], references: [userId], onDelete: SetNull)

  @@index([provider, status, nextAttemptAt])
  @@index([athleteId, provider])
  @@index([provider, externalActivityId])
}

model CronRun {
  id               String   @id @default(cuid())
  kind             String
  status           String
  startedAt        DateTime @default(now())
  finishedAt       DateTime?
  durationMs       Int?
  processedAthletes Int?
  importedActivities Int?
  matchedActivities Int?
  unplannedActivities Int?
  errorCount       Int?
  firstError       String?
  summaryJson      Json?

  createdAt DateTime @default(now())

  @@index([kind, startedAt])
  @@index([status, startedAt])
}

model AthleteIntakeResponse {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  status      AthleteIntakeResponseStatus @default(DRAFT)
  // Metadata about how this intake was created. Keep out of draftJson so evidence remains clean.
  source      String?
  aiMode      String?
  draftJson   Json?
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete  AthleteProfile   @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach    User             @relation(fields: [coachId], references: [id], onDelete: Restrict)
  evidence IntakeEvidence[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
}

model IntakeEvidence {
  id               String @id @default(cuid())
  athleteId        String // AthleteProfile.userId
  coachId          String // User.id
  intakeResponseId String

  questionKey String
  answerJson  Json

  // Append-only evidence. Records should never be updated or deleted by application logic.
  createdAt DateTime @default(now())

  athlete        AthleteProfile        @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach          User                  @relation(fields: [coachId], references: [id], onDelete: Restrict)
  intakeResponse AthleteIntakeResponse @relation(fields: [intakeResponseId], references: [id], onDelete: Restrict)

  @@index([intakeResponseId])
  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model AthleteProfileAI {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  // Deterministic extraction output (idempotent for a given evidence set)
  extractedProfileJson Json
  extractedSummaryText String
  extractedFlagsJson   Json?
  evidenceHash         String

  // Coach edits override extracted fields (stored separately).
  coachOverridesJson Json?

  status     AthleteProfileAIStatus @default(DRAFT)
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  @@unique([athleteId, evidenceHash])
  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model AthleteIntakeSubmission {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  answersJson Json
  submittedAt DateTime @default(now())

  createdAt DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation("CoachToIntakeSubmissions", fields: [coachId], references: [id], onDelete: Restrict)

  @@index([athleteId, submittedAt])
  @@index([coachId, submittedAt])
}

model AthleteBrief {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  generatedAt DateTime @default(now())
  inputHash   String
  briefJson   Json
  summaryText String?
  riskFlags   String[] @default([])
  sourcesPresent Json?
  aiMode      String?

  updatedAt DateTime @updatedAt

  createdAt DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation("CoachToAthleteBriefs", fields: [coachId], references: [id], onDelete: Restrict)

  @@unique([athleteId, inputHash])
  @@index([athleteId, generatedAt])
  @@index([coachId, generatedAt])
}

model CoachIntent {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  intentText String
  createdAt  DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model AiPlanDraft {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  source AiPlanDraftSource @default(AI_DRAFT)
  status AiPlanDraftStatus @default(DRAFT)

  // Uses existing plan primitives by reference in JSON, but does not create/modify any live plan records.
  planJson Json

  // Draft-local inputs used to generate the draft deterministically.
  setupJson Json?
  setupHash String?

  // Plan reasoning derived from profile + setup (deterministic, no LLM).
  reasoningJson Json?

  // Plan library selection metadata.
  planSourceSelectionJson Json?

  // Tranche 4: publish visibility (AI-domain only; no coupling to existing plan tables).
  visibilityStatus         AiPlanDraftVisibilityStatus @default(DRAFT)
  publishedAt              DateTime?
  publishedByCoachId       String?
  lastPublishedHash        String?
  lastPublishedSummaryText String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  proposals PlanChangeProposal[]
  audits    PlanChangeAudit[]

  weeks    AiPlanDraftWeek[]
  sessions AiPlanDraftSession[]

  publishSnapshots AiPlanDraftPublishSnapshot[]

  publishAcks AiPlanPublishAck[]

  feedback AthleteSessionFeedback[]
  triggers AdaptationTrigger[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
  @@index([visibilityStatus, publishedAt])
}

model AiPlanDraftPublishSnapshot {
  id        String @id @default(cuid())
  draftId   String
  athleteId String // denormalized for query convenience
  coachId   String // denormalized for query convenience

  hash        String
  planJson    Json
  summaryText String

  publishedAt        DateTime @default(now())
  publishedByCoachId String?

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, hash])
  @@index([draftId, publishedAt])
  @@index([athleteId, publishedAt])
}

model AiPlanPublishAck {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  draftId   String

  lastSeenPublishedHash String
  lastSeenAt            DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  draft   AiPlanDraft    @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([athleteId, draftId])
  @@index([athleteId, draftId])
}

model AthleteSessionFeedback {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id
  draftId   String
  sessionId String

  completedStatus AthleteSessionFeedbackCompletedStatus
  rpe             Int?
  feel            AthleteSessionFeedbackFeel?
  sorenessFlag    Boolean                               @default(false)
  sorenessNotes   String?
  sleepQuality    Int?

  createdAt DateTime @default(now())

  athlete AthleteProfile     @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User               @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draft   AiPlanDraft        @relation(fields: [draftId], references: [id], onDelete: Cascade)
  session AiPlanDraftSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([athleteId, createdAt])
  @@index([draftId, createdAt])
  @@index([sessionId, createdAt])
}

model AdaptationTrigger {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id
  draftId   String

  triggerType  AdaptationTriggerType
  windowStart  DateTime
  windowEnd    DateTime
  evidenceJson Json

  createdAt DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draft   AiPlanDraft    @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, triggerType, windowStart, windowEnd])
  @@index([athleteId, createdAt])
  @@index([draftId, createdAt])
  @@index([draftId, triggerType, createdAt])
}

model AiPlanDraftWeek {
  id        String @id @default(cuid())
  draftId   String
  weekIndex Int

  locked Boolean @default(false)

  // Cached summaries for quick UI rendering.
  sessionsCount Int @default(0)
  totalMinutes  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, weekIndex])
  @@index([draftId, weekIndex])
}

model AiPlanDraftSession {
  id        String @id @default(cuid())
  draftId   String
  weekIndex Int
  ordinal   Int

  dayOfWeek       Int
  discipline      String
  type            String
  durationMinutes Int
  notes           String?

  // v1: per-session structured detail (AI-authored) + idempotency hash.
  detailJson        Json?
  detailInputHash   String?
  detailGeneratedAt DateTime?
  detailMode        String?

  locked Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  feedback AthleteSessionFeedback[]

  @@index([draftId, id])
  @@index([draftId, detailInputHash])
  @@index([draftId, weekIndex])
  @@unique([draftId, weekIndex, ordinal])
}

model PlanChangeProposal {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  status PlanChangeProposalStatus @default(DRAFT)

  // Optional linkage to an AI draft plan. No linkage is required to propose a change.
  draftPlanId String?

  // Tranche 3: deterministic proposal execution against AiPlanDraft only.
  rationaleText   String?
  diffJson        Json?
  triggerIds      String[]  @default([])
  respectsLocks   Boolean   @default(true)
  coachDecisionAt DateTime?
  appliedAt       DateTime?

  // Optional opaque reference to an existing plan (string-only to avoid FK coupling).
  targetPlanRef String?

  // The proposal "shape" only. No execution in Tranche 1.
  proposalJson Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete   AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach     User           @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draftPlan AiPlanDraft?   @relation(fields: [draftPlanId], references: [id], onDelete: SetNull)

  audits PlanChangeAudit[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
  @@index([draftPlanId, status, createdAt])
}

model PlanChangeAudit {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  proposalId String?

  // Opaque event + diff payloads for auditability.
  eventType String
  diffJson  Json?

  // Tranche 3: explicit change records for AiPlanDraft-only application.
  actorType         PlanChangeAuditActorType @default(COACH)
  changeSummaryText String?
  draftPlanId       String?

  createdAt DateTime @default(now())

  athlete  AthleteProfile      @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach    User                @relation(fields: [coachId], references: [id], onDelete: Restrict)
  proposal PlanChangeProposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  draftPlan AiPlanDraft? @relation(fields: [draftPlanId], references: [id], onDelete: SetNull)

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([proposalId, createdAt])
  @@index([draftPlanId, createdAt])
}

// --- AI Plan Builder (Tranche 10) ---
// DB-backed LLM rate limiting + metadata-only invocation audits.

model AiLlmRateLimitEvent {
  id         String               @id @default(cuid())
  actorType  AiInvocationActorType
  actorId    String
  capability String
  createdAt  DateTime             @default(now())

  coachId   String?
  athleteId String?

  coach   User?           @relation("AiLlmRateLimitEventCoach", fields: [coachId], references: [id], onDelete: SetNull)
  athlete AthleteProfile? @relation("AiLlmRateLimitEventAthlete", fields: [athleteId], references: [userId], onDelete: SetNull)

  @@index([actorType, actorId, createdAt])
  @@index([capability, createdAt])
  @@index([coachId, createdAt])
  @@index([athleteId, createdAt])
}

model AiInvocationAudit {
  id            String               @id @default(cuid())
  actorType     AiInvocationActorType
  actorId       String
  coachId       String?
  athleteId     String?

  capability    String
  specVersion   String
  effectiveMode String

  provider      String
  model         String?

  inputHash     String
  outputHash    String

  durationMs    Int
  maxOutputTokens Int?
  timeoutMs     Int?
  retryCount    Int
  fallbackUsed  Boolean              @default(false)
  errorCode     String?

  createdAt     DateTime             @default(now())

  coach   User?           @relation("AiInvocationAuditCoach", fields: [coachId], references: [id], onDelete: SetNull)
  athlete AthleteProfile? @relation("AiInvocationAuditAthlete", fields: [athleteId], references: [userId], onDelete: SetNull)

  @@index([actorType, actorId, createdAt])
  @@index([capability, createdAt])
  @@index([coachId, createdAt])
  @@index([athleteId, createdAt])
}

model AiInvocationDailyRollup {
  id              String   @id @default(cuid())
  date            DateTime // UTC day, stored at midnight UTC
  provider        String
  model           String
  capability      String
  effectiveMode   String

  callCount       Int
  fallbackCount   Int
  errorCount      Int
  retryCountTotal Int

  avgDurationMs   Int
  p95DurationMs   Int?

  maxOutputTokensAvg   Int
  estimatedOutputTokens Int
  estimatedCostUsd      Float

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([date, provider, model, capability, effectiveMode])
  @@index([date])
  @@index([capability, date])
}

model AiUsageAlert {
  id             String               @id @default(cuid())
  createdAt      DateTime             @default(now())
  dateRangeStart DateTime
  dateRangeEnd   DateTime

  // NOTE: Postgres UNIQUE indexes treat NULLs as distinct, so a composite unique
  // over nullable columns will not de-dupe alerts where provider/model/capability
  // are NULL. Use a stable, non-null unique key instead.
  dedupeKey      String               @unique

  severity       AiUsageAlertSeverity
  alertType      AiUsageAlertType
  scope          AiUsageAlertScope

  capability     String?
  provider       String?
  model          String?

  observedValue  Float
  thresholdValue Float
  message        String

  acknowledgedAt DateTime?
  acknowledgedBy String?
  @@index([createdAt(sort: Desc)])
  @@index([alertType, createdAt(sort: Desc)])
  @@index([dateRangeStart])
}
