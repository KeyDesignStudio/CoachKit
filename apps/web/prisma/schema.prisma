generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  COACH
  ADMIN
  ATHLETE
}

enum CalendarItemStatus {
  PLANNED
  COMPLETED_MANUAL
  COMPLETED_SYNCED
  COMPLETED_SYNCED_DRAFT
  SKIPPED
  MODIFIED
}

enum CompletionSource {
  MANUAL
  STRAVA
  GARMIN
  FILE
}

enum GroupVisibilityType {
  ALL
  SQUAD
  SELECTED
}

enum PlanWeekStatus {
  DRAFT
  PUBLISHED
}

enum OAuthProvider {
  STRAVA
}

enum TrainingPlanFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  AD_HOC
}

enum AthletePlanStatus {
  ACTIVE
  ARCHIVED
}

enum StravaSyncIntentStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

// --- AI Plan Builder (v1) ---
// Tranche 1: additive models only. No coupling to existing plan workflows.

enum AthleteIntakeResponseStatus {
  DRAFT
  SUBMITTED
}

enum AthleteProfileAIStatus {
  DRAFT
  APPROVED
}

enum AiPlanDraftSource {
  AI_DRAFT
}

enum AiPlanDraftStatus {
  DRAFT
}

enum AiPlanDraftVisibilityStatus {
  DRAFT
  PUBLISHED
}

enum PlanChangeProposalStatus {
  DRAFT
  PROPOSED
  APPROVED
  REJECTED
  APPLIED
  EXPIRED
}

enum AthleteSessionFeedbackCompletedStatus {
  DONE
  PARTIAL
  SKIPPED
}

enum AthleteSessionFeedbackFeel {
  EASY
  OK
  HARD
  TOO_HARD
}

enum AdaptationTriggerType {
  MISSED_KEY
  SORENESS
  TOO_HARD
  HIGH_COMPLIANCE
}

enum PlanChangeAuditActorType {
  COACH
  AI_SYSTEM
}

enum AiInvocationActorType {
  COACH
  ATHLETE
  SYSTEM
}

// --- AI Plan Builder (Tranche 12) ---
// Usage rollups + directional cost estimates + soft alerts.

enum AiUsageAlertSeverity {
  INFO
  WARN
  ERROR
}

enum AiUsageAlertType {
  HIGH_CALL_VOLUME
  HIGH_FALLBACK_RATE
  HIGH_ERROR_RATE
  HIGH_RETRY_RATE
  HIGH_P95_LATENCY
  HIGH_COST_ESTIMATE
}

enum AiUsageAlertScope {
  GLOBAL
  CAPABILITY
  COACH
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  role           UserRole
  timezone       String   @default("Australia/Brisbane")
  authProviderId String?  @unique // Clerk user ID for authentication
  createdAt      DateTime @default(now())

  // Relations
  athleteProfile            AthleteProfile?
  coachedAthletes           AthleteProfile[]      @relation("CoachToAthletes")
  comments                  Comment[]
  messageThreadsAsCoach     MessageThread[]       @relation("CoachThreads")
  messageThreadsAsAthlete   MessageThread[]       @relation("AthleteThreads")
  messages                  Message[]
  squads                    Squad[]
  workoutTemplates          WorkoutTemplate[]
  groupSessions             GroupSession[]
  calendarItemsCoached      CalendarItem[]
  branding                  CoachBranding?
  workoutTitles             WorkoutTitle[]
  planWeeks                 PlanWeek[]
  coachJournalEntries       CoachJournalEntry[]
  oauthStates               OAuthState[]
  athletePlanInstances      AthletePlanInstance[] @relation("AthletePlanInstances")
  coachCreatedPlanInstances AthletePlanInstance[] @relation("CoachCreatedPlanInstances")

  // AI Plan Builder (v1)
  aiPlanBuilderIntakeResponses    AthleteIntakeResponse[]
  aiPlanBuilderEvidence           IntakeEvidence[]
  aiPlanBuilderProfiles           AthleteProfileAI[]
  aiPlanBuilderIntents            CoachIntent[]
  aiPlanBuilderDraftPlans         AiPlanDraft[]
  aiPlanBuilderProposals          PlanChangeProposal[]
  aiPlanBuilderAudits             PlanChangeAudit[]
  aiPlanBuilderSessionFeedback    AthleteSessionFeedback[]
  aiPlanBuilderAdaptationTriggers AdaptationTrigger[]

  // AI Plan Builder (Tranche 10)
  aiInvocationAudits       AiInvocationAudit[]      @relation("AiInvocationAuditCoach")
  aiLlmRateLimitEvents     AiLlmRateLimitEvent[]    @relation("AiLlmRateLimitEventCoach")

  @@index([role])
}

model AthleteProfile {
  userId                  String                @id
  coachId                 String
  disciplines             String[] // e.g. ["RUN","BIKE","SWIM"]
  goalsText               String?
  planCadenceDays         Int                   @default(7) // LEGACY: kept for backward compatibility. Do not use in UI. Use trainingPlanFrequency/day/weekOfMonth.
  trainingPlanFrequency   TrainingPlanFrequency @default(AD_HOC)
  trainingPlanDayOfWeek   Int?
  trainingPlanWeekOfMonth Int?
  zonesJson               Json?
  coachNotes              String?
  dateOfBirth             DateTime?

  // Calendar Sync (private iCal subscription)
  icalToken          String?   @unique
  icalTokenRotatedAt DateTime?

  // v1: Default location for weather on workout detail pages.
  defaultLat           Float?
  defaultLon           Float?
  defaultLocationLabel String?

  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  coach User @relation("CoachToAthletes", fields: [coachId], references: [id], onDelete: Restrict)

  calendarItems       CalendarItem[]
  completedActivities CompletedActivity[]
  painReports         PainReport[]
  squadMemberships    SquadMember[]
  groupSessionTargets GroupSessionTarget[]
  planWeeks           PlanWeek[]
  coachJournalEntries CoachJournalEntry[]
  stravaConnection    StravaConnection?
  stravaSyncIntents   StravaSyncIntent[]

  // AI Plan Builder (v1)
  aiPlanBuilderIntakeResponses    AthleteIntakeResponse[]
  aiPlanBuilderEvidence           IntakeEvidence[]
  aiPlanBuilderProfiles           AthleteProfileAI[]
  aiPlanBuilderIntents            CoachIntent[]
  aiPlanBuilderDraftPlans         AiPlanDraft[]
  aiPlanBuilderProposals          PlanChangeProposal[]
  aiPlanBuilderAudits             PlanChangeAudit[]
  aiPlanBuilderSessionFeedback    AthleteSessionFeedback[]
  aiPlanBuilderAdaptationTriggers AdaptationTrigger[]
  aiPlanBuilderPublishAcks        AiPlanPublishAck[]

  // AI Plan Builder (Tranche 10)
  aiInvocationAudits   AiInvocationAudit[]   @relation("AiInvocationAuditAthlete")
  aiLlmRateLimitEvents AiLlmRateLimitEvent[] @relation("AiLlmRateLimitEventAthlete")

  @@index([coachId])
}

model Squad {
  id        String   @id @default(cuid())
  coachId   String
  name      String
  createdAt DateTime @default(now())

  coach               User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  members             SquadMember[]
  groupSessionTargets GroupSessionTarget[]

  @@unique([coachId, name])
  @@index([coachId])
}

model SquadMember {
  squadId   String
  athleteId String // references AthleteProfile.userId
  createdAt DateTime @default(now())

  squad   Squad          @relation(fields: [squadId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@id([squadId, athleteId])
  @@index([athleteId])
}

model WorkoutTemplate {
  id                 String   @id @default(cuid())
  coachId            String
  discipline         String
  subtype            String?
  title              String
  structureJson      Json?
  defaultTargetsJson Json?
  notes              String?
  attachmentsJson    Json?
  createdAt          DateTime @default(now())

  coach         User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  calendarItems CalendarItem[]

  @@index([coachId])
  @@index([discipline])
}

model WorkoutTitle {
  id         String   @id @default(cuid())
  coachId    String
  discipline String
  title      String
  isArchived Boolean  @default(false)
  createdAt  DateTime @default(now())

  coach User @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, discipline, title])
  @@index([coachId, discipline, isArchived])
}

model PlanTemplate {
  id                String   @id @default(cuid())
  planIdExternal    String   @unique @map("externalPlanId")
  name              String
  tags              String[] @default([])
  level             String?
  durationDays      Int?
  goalDistancesJson Json?
  goalTimesJson     Json?
  sourceFile        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  scheduleRows         PlanTemplateScheduleRow[]
  athletePlanInstances AthletePlanInstance[]

  @@index([planIdExternal])
}

model PlanTemplateScheduleRow {
  id             String   @id @default(cuid())
  planTemplateId String
  weekIndex      Int
  dayIndex       Int
  dayOfWeek      Int
  ordinal        Int      @default(0)
  isOptional     Boolean  @default(false)
  isOff          Boolean  @default(false)
  rawText        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  planTemplate             PlanTemplate              @relation(fields: [planTemplateId], references: [id], onDelete: Cascade)
  athletePlanInstanceItems AthletePlanInstanceItem[]

  @@unique([planTemplateId, weekIndex, dayIndex, ordinal])
  @@index([planTemplateId, weekIndex])
  @@index([planTemplateId, dayOfWeek])
}

model AthletePlanInstance {
  id               String            @id @default(cuid())
  athleteId        String
  planTemplateId   String
  startDateLocal   DateTime
  timezone         String
  status           AthletePlanStatus @default(ACTIVE)
  createdByCoachId String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  athlete        User                      @relation("AthletePlanInstances", fields: [athleteId], references: [id], onDelete: Cascade)
  planTemplate   PlanTemplate              @relation(fields: [planTemplateId], references: [id], onDelete: Restrict)
  createdByCoach User                      @relation("CoachCreatedPlanInstances", fields: [createdByCoachId], references: [id], onDelete: Restrict)
  items          AthletePlanInstanceItem[]
  calendarItems  CalendarItem[]

  @@index([athleteId, status])
  @@index([planTemplateId])
  @@index([createdByCoachId])
}

model AthletePlanInstanceItem {
  id                        String   @id @default(cuid())
  athletePlanInstanceId     String
  planTemplateScheduleRowId String
  calendarItemId            String
  createdAt                 DateTime @default(now())

  athletePlanInstance     AthletePlanInstance     @relation(fields: [athletePlanInstanceId], references: [id], onDelete: Cascade)
  planTemplateScheduleRow PlanTemplateScheduleRow @relation(fields: [planTemplateScheduleRowId], references: [id], onDelete: Cascade)
  calendarItem            CalendarItem            @relation(fields: [calendarItemId], references: [id], onDelete: Cascade)

  @@unique([athletePlanInstanceId, planTemplateScheduleRowId])
  @@index([calendarItemId])
}

model GroupSession {
  id               String              @id @default(cuid())
  coachId          String
  title            String
  discipline       String
  location         String?
  startTimeLocal   String // "06:00" etc (keep MVP simple)
  durationMinutes  Int
  distanceMeters   Float?
  intensityTarget  String?
  tags             String[]            @default([])
  equipment        String[]            @default([])
  workoutStructure Json?
  notes            String?
  description      String?
  recurrenceRule   String // iCal RRULE string
  visibilityType   GroupVisibilityType @default(ALL)
  optionalFlag     Boolean             @default(false)
  createdAt        DateTime            @default(now())

  coach         User                 @relation(fields: [coachId], references: [id], onDelete: Cascade)
  targets       GroupSessionTarget[]
  calendarItems CalendarItem[]

  @@index([coachId])
}

model GroupSessionTarget {
  id             String  @id @default(cuid())
  groupSessionId String
  athleteId      String?
  squadId        String?

  groupSession GroupSession    @relation(fields: [groupSessionId], references: [id], onDelete: Cascade)
  athlete      AthleteProfile? @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  squad        Squad?          @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@index([groupSessionId])
  @@index([athleteId])
  @@index([squadId])
}

model CalendarItem {
  id                     String             @id @default(cuid())
  athleteId              String // AthleteProfile.userId
  coachId                String
  athletePlanInstanceId  String?
  date                   DateTime // use date-only at midnight; interpret in timezone in UI
  plannedStartTimeLocal  String?
  // For non-planned sessions (e.g. recorded-from-provider).
  origin                 String?
  planningStatus         String?
  sourceActivityId       String?
  discipline             String
  subtype                String?
  title                  String
  plannedDurationMinutes Int?
  plannedDistanceKm      Float?
  distanceMeters         Float?
  intensityTarget        String?
  tags                   String[]           @default([])
  equipment              String[]           @default([])
  workoutStructure       Json?
  notes                  String?
  intensityType          String?
  intensityTargetJson    Json?
  workoutDetail          String?
  attachmentsJson        Json?
  status                 CalendarItemStatus @default(PLANNED)
  templateId             String?
  groupSessionId         String?
  reviewedAt             DateTime?
  actionAt               DateTime?

  deletedAt       DateTime?
  deletedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete             AthleteProfile       @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  coach               User                 @relation(fields: [coachId], references: [id], onDelete: Restrict)
  athletePlanInstance AthletePlanInstance? @relation(fields: [athletePlanInstanceId], references: [id], onDelete: SetNull)
  template            WorkoutTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  groupSession        GroupSession?        @relation(fields: [groupSessionId], references: [id], onDelete: SetNull)

  completedActivities      CompletedActivity[]
  comments                 Comment[]
  athletePlanInstanceItems AthletePlanInstanceItem[]

  @@unique([athleteId, origin, sourceActivityId])
  @@index([athleteId, date])
  @@index([coachId, date])
  @@index([coachId, athleteId, date])
  @@index([reviewedAt])
  @@index([coachId, reviewedAt, actionAt])
  @@index([status])
  @@index([coachId, reviewedAt, status])
  @@index([deletedAt])
  @@index([athletePlanInstanceId])
}

model CompletedActivity {
  id                 String           @id @default(cuid())
  athleteId          String
  calendarItemId     String?
  source             CompletionSource
  externalProvider   String?
  externalActivityId String?
  startTime          DateTime
  durationMinutes    Int
  distanceKm         Float?
  rpe                Int?
  notes              String?
  painFlag           Boolean          @default(false)
  confirmedAt        DateTime?
  metricsJson        Json?
  fileUrl            String?
  createdAt          DateTime         @default(now())

  athlete      AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  calendarItem CalendarItem?  @relation(fields: [calendarItemId], references: [id], onDelete: SetNull)

  @@unique([athleteId, source, externalActivityId])
  @@index([athleteId, startTime])
  @@index([calendarItemId])
}

model Comment {
  id             String   @id @default(cuid())
  calendarItemId String
  authorId       String
  body           String
  createdAt      DateTime @default(now())

  calendarItem CalendarItem @relation(fields: [calendarItemId], references: [id], onDelete: Cascade)
  author       User         @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([calendarItemId, createdAt])
}

model MessageThread {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach    User      @relation("CoachThreads", fields: [coachId], references: [id], onDelete: Cascade)
  athlete  User      @relation("AthleteThreads", fields: [athleteId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([coachId, athleteId])
  @@index([coachId])
  @@index([athleteId])
}

model Message {
  id           String   @id @default(cuid())
  threadId     String
  senderUserId String   @map("authorId")
  senderRole   UserRole @default(COACH)
  body         String
  createdAt    DateTime @default(now())

  deletedAt       DateTime?
  deletedByUserId String?

  coachReadAt     DateTime?
  athleteReadAt   DateTime?
  coachReviewedAt DateTime?

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User          @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model PainReport {
  id           String   @id @default(cuid())
  athleteId    String
  date         DateTime
  bodyLocation String
  severity     Int
  durationDays Int?
  notes        String?
  createdAt    DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId, date])
}

model PlanWeek {
  id          String         @id @default(cuid())
  coachId     String
  athleteId   String // AthleteProfile.userId
  weekStart   DateTime // Monday date at midnight
  status      PlanWeekStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  coach   User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@unique([coachId, athleteId, weekStart])
  @@index([coachId, weekStart])
  @@index([athleteId, weekStart])
}

model CoachBranding {
  coachId     String   @id
  displayName String   @default("CoachKit")
  logoUrl     String?
  darkLogoUrl String?
  updatedAt   DateTime @updatedAt

  coach User @relation(fields: [coachId], references: [id], onDelete: Cascade)
}

model CoachJournalEntry {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String // AthleteProfile.userId
  entryDate DateTime
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coach   User           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId, entryDate(sort: Desc)])
  @@index([coachId])
}

model OAuthState {
  id         String        @id @default(cuid())
  provider   OAuthProvider
  userId     String
  state      String        @unique
  redirectTo String?
  expiresAt  DateTime
  createdAt  DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([provider, userId])
  @@index([expiresAt])
}

model StravaConnection {
  id              String    @id @default(cuid())
  athleteId       String    @unique // AthleteProfile.userId
  stravaAthleteId String    @unique
  accessToken     String
  refreshToken    String
  expiresAt       DateTime
  scope           String?
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@index([athleteId])
  @@index([stravaAthleteId])
  @@index([expiresAt])
}

model StravaSyncIntent {
  id               String @id @default(cuid())
  athleteId        String // AthleteProfile.userId
  stravaAthleteId  String
  stravaActivityId String
  eventType        String

  status        StravaSyncIntentStatus @default(PENDING)
  attempts      Int                    @default(0)
  nextAttemptAt DateTime?
  lastError     String?

  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)

  @@unique([athleteId, stravaActivityId])
  @@index([status, createdAt])
  @@index([athleteId, status])
}

model AthleteIntakeResponse {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  status      AthleteIntakeResponseStatus @default(DRAFT)
  draftJson   Json?
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete  AthleteProfile   @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach    User             @relation(fields: [coachId], references: [id], onDelete: Restrict)
  evidence IntakeEvidence[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
}

model IntakeEvidence {
  id               String @id @default(cuid())
  athleteId        String // AthleteProfile.userId
  coachId          String // User.id
  intakeResponseId String

  questionKey String
  answerJson  Json

  // Append-only evidence. Records should never be updated or deleted by application logic.
  createdAt DateTime @default(now())

  athlete        AthleteProfile        @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach          User                  @relation(fields: [coachId], references: [id], onDelete: Restrict)
  intakeResponse AthleteIntakeResponse @relation(fields: [intakeResponseId], references: [id], onDelete: Restrict)

  @@index([intakeResponseId])
  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model AthleteProfileAI {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  // Deterministic extraction output (idempotent for a given evidence set)
  extractedProfileJson Json
  extractedSummaryText String
  extractedFlagsJson   Json?
  evidenceHash         String

  // Coach edits override extracted fields (stored separately).
  coachOverridesJson Json?

  status     AthleteProfileAIStatus @default(DRAFT)
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  @@unique([athleteId, evidenceHash])
  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model CoachIntent {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  intentText String
  createdAt  DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
}

model AiPlanDraft {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  source AiPlanDraftSource @default(AI_DRAFT)
  status AiPlanDraftStatus @default(DRAFT)

  // Uses existing plan primitives by reference in JSON, but does not create/modify any live plan records.
  planJson Json

  // Draft-local inputs used to generate the draft deterministically.
  setupJson Json?
  setupHash String?

  // Tranche 4: publish visibility (AI-domain only; no coupling to existing plan tables).
  visibilityStatus         AiPlanDraftVisibilityStatus @default(DRAFT)
  publishedAt              DateTime?
  publishedByCoachId       String?
  lastPublishedHash        String?
  lastPublishedSummaryText String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)

  proposals PlanChangeProposal[]
  audits    PlanChangeAudit[]

  weeks    AiPlanDraftWeek[]
  sessions AiPlanDraftSession[]

  publishSnapshots AiPlanDraftPublishSnapshot[]

  publishAcks AiPlanPublishAck[]

  feedback AthleteSessionFeedback[]
  triggers AdaptationTrigger[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
  @@index([visibilityStatus, publishedAt])
}

model AiPlanDraftPublishSnapshot {
  id        String @id @default(cuid())
  draftId   String
  athleteId String // denormalized for query convenience
  coachId   String // denormalized for query convenience

  hash        String
  planJson    Json
  summaryText String

  publishedAt        DateTime @default(now())
  publishedByCoachId String?

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, hash])
  @@index([draftId, publishedAt])
  @@index([athleteId, publishedAt])
}

model AiPlanPublishAck {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  draftId   String

  lastSeenPublishedHash String
  lastSeenAt            DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Cascade)
  draft   AiPlanDraft    @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([athleteId, draftId])
  @@index([athleteId, draftId])
}

model AthleteSessionFeedback {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id
  draftId   String
  sessionId String

  completedStatus AthleteSessionFeedbackCompletedStatus
  rpe             Int?
  feel            AthleteSessionFeedbackFeel?
  sorenessFlag    Boolean                               @default(false)
  sorenessNotes   String?
  sleepQuality    Int?

  createdAt DateTime @default(now())

  athlete AthleteProfile     @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User               @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draft   AiPlanDraft        @relation(fields: [draftId], references: [id], onDelete: Cascade)
  session AiPlanDraftSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([athleteId, createdAt])
  @@index([draftId, createdAt])
  @@index([sessionId, createdAt])
}

model AdaptationTrigger {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id
  draftId   String

  triggerType  AdaptationTriggerType
  windowStart  DateTime
  windowEnd    DateTime
  evidenceJson Json

  createdAt DateTime @default(now())

  athlete AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach   User           @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draft   AiPlanDraft    @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, triggerType, windowStart, windowEnd])
  @@index([athleteId, createdAt])
  @@index([draftId, createdAt])
  @@index([draftId, triggerType, createdAt])
}

model AiPlanDraftWeek {
  id        String @id @default(cuid())
  draftId   String
  weekIndex Int

  locked Boolean @default(false)

  // Cached summaries for quick UI rendering.
  sessionsCount Int @default(0)
  totalMinutes  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, weekIndex])
  @@index([draftId, weekIndex])
}

model AiPlanDraftSession {
  id        String @id @default(cuid())
  draftId   String
  weekIndex Int
  ordinal   Int

  dayOfWeek       Int
  discipline      String
  type            String
  durationMinutes Int
  notes           String?

  locked Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  draft AiPlanDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  feedback AthleteSessionFeedback[]

  @@unique([draftId, weekIndex, ordinal])
  @@index([draftId, weekIndex])
}

model PlanChangeProposal {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  status PlanChangeProposalStatus @default(DRAFT)

  // Optional linkage to an AI draft plan. No linkage is required to propose a change.
  draftPlanId String?

  // Tranche 3: deterministic proposal execution against AiPlanDraft only.
  rationaleText   String?
  diffJson        Json?
  triggerIds      String[]  @default([])
  respectsLocks   Boolean   @default(true)
  coachDecisionAt DateTime?
  appliedAt       DateTime?

  // Optional opaque reference to an existing plan (string-only to avoid FK coupling).
  targetPlanRef String?

  // The proposal "shape" only. No execution in Tranche 1.
  proposalJson Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete   AthleteProfile @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach     User           @relation(fields: [coachId], references: [id], onDelete: Restrict)
  draftPlan AiPlanDraft?   @relation(fields: [draftPlanId], references: [id], onDelete: SetNull)

  audits PlanChangeAudit[]

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
  @@index([draftPlanId, status, createdAt])
}

model PlanChangeAudit {
  id        String @id @default(cuid())
  athleteId String // AthleteProfile.userId
  coachId   String // User.id

  proposalId String?

  // Opaque event + diff payloads for auditability.
  eventType String
  diffJson  Json?

  // Tranche 3: explicit change records for AiPlanDraft-only application.
  actorType         PlanChangeAuditActorType @default(COACH)
  changeSummaryText String?
  draftPlanId       String?

  createdAt DateTime @default(now())

  athlete  AthleteProfile      @relation(fields: [athleteId], references: [userId], onDelete: Restrict)
  coach    User                @relation(fields: [coachId], references: [id], onDelete: Restrict)
  proposal PlanChangeProposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  draftPlan AiPlanDraft? @relation(fields: [draftPlanId], references: [id], onDelete: SetNull)

  @@index([athleteId, createdAt])
  @@index([coachId, createdAt])
  @@index([proposalId, createdAt])
  @@index([draftPlanId, createdAt])
}

// --- AI Plan Builder (Tranche 10) ---
// DB-backed LLM rate limiting + metadata-only invocation audits.

model AiLlmRateLimitEvent {
  id         String               @id @default(cuid())
  actorType  AiInvocationActorType
  actorId    String
  capability String
  createdAt  DateTime             @default(now())

  coachId   String?
  athleteId String?

  coach   User?           @relation("AiLlmRateLimitEventCoach", fields: [coachId], references: [id], onDelete: SetNull)
  athlete AthleteProfile? @relation("AiLlmRateLimitEventAthlete", fields: [athleteId], references: [userId], onDelete: SetNull)

  @@index([actorType, actorId, createdAt])
  @@index([capability, createdAt])
  @@index([coachId, createdAt])
  @@index([athleteId, createdAt])
}

model AiInvocationAudit {
  id            String               @id @default(cuid())
  actorType     AiInvocationActorType
  actorId       String
  coachId       String?
  athleteId     String?

  capability    String
  specVersion   String
  effectiveMode String

  provider      String
  model         String?

  inputHash     String
  outputHash    String

  durationMs    Int
  maxOutputTokens Int?
  timeoutMs     Int?
  retryCount    Int
  fallbackUsed  Boolean              @default(false)
  errorCode     String?

  createdAt     DateTime             @default(now())

  coach   User?           @relation("AiInvocationAuditCoach", fields: [coachId], references: [id], onDelete: SetNull)
  athlete AthleteProfile? @relation("AiInvocationAuditAthlete", fields: [athleteId], references: [userId], onDelete: SetNull)

  @@index([actorType, actorId, createdAt])
  @@index([capability, createdAt])
  @@index([coachId, createdAt])
  @@index([athleteId, createdAt])
}

model AiInvocationDailyRollup {
  id              String   @id @default(cuid())
  date            DateTime // UTC day, stored at midnight UTC
  provider        String
  model           String
  capability      String
  effectiveMode   String

  callCount       Int
  fallbackCount   Int
  errorCount      Int
  retryCountTotal Int

  avgDurationMs   Int
  p95DurationMs   Int?

  maxOutputTokensAvg   Int
  estimatedOutputTokens Int
  estimatedCostUsd      Float

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([date, provider, model, capability, effectiveMode])
  @@index([date])
  @@index([capability, date])
}

model AiUsageAlert {
  id             String               @id @default(cuid())
  createdAt      DateTime             @default(now())
  dateRangeStart DateTime
  dateRangeEnd   DateTime

  // NOTE: Postgres UNIQUE indexes treat NULLs as distinct, so a composite unique
  // over nullable columns will not de-dupe alerts where provider/model/capability
  // are NULL. Use a stable, non-null unique key instead.
  dedupeKey      String               @unique

  severity       AiUsageAlertSeverity
  alertType      AiUsageAlertType
  scope          AiUsageAlertScope

  capability     String?
  provider       String?
  model          String?

  observedValue  Float
  thresholdValue Float
  message        String

  acknowledgedAt DateTime?
  acknowledgedBy String?
  @@index([createdAt(sort: Desc)])
  @@index([alertType, createdAt(sort: Desc)])
  @@index([dateRangeStart])
}
